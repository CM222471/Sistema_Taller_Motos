<<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="fragments/header :: header(title = 'Inicio')">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
</head>

<body>
    <div id="wrapper" class="d-flex">
        <!-- Sidebar -->
        <div th:replace="fragments/sidebar :: sidebar"></div>

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
                <div class="container-fluid p-4">

                    <!-- Encabezado -->
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
                        <h1 class="h2">Panel de Administración</h1>
                    </div>

                    <!-- Tarjetas KPI -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-white bg-primary shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">Total Productos</h5>
                                    <p class="card-text" id="totalProductos">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-success shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">Stock Crítico</h5>
                                    <p class="card-text" id="productosStockBajo">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-warning shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">Productos Más Vendidos</h5>
                                    <p class="card-text" id="productosMasVendidos">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-info shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">Categorías</h5>
                                    <p class="card-text" id="totalCategorias">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gráficos -->
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-header">Stock por Categoría</div>
                                <div class="card-body">
                                    <canvas id="graficoStockCategoria"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-header">Movimientos por Tipo</div>
                                <div class="card-body">
                                    <canvas id="graficoTipoMovimientos"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-header">Productos con Stock Bajo</div>
                                <div class="card-body">
                                    <canvas id="graficoStockBajo"></canvas>
                                    <ul id="listaProductosBajoStock" class="mt-3"></ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-header">Productos Más Vendidos</div>
                                <div class="card-body">
                                    <canvas id="graficoProductosMasVendidos"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alerta Stock Exceso -->
                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-header bg-danger text-white">Productos con Stock Excesivo</div>
                                <div class="card-body">
                                    <ul id="listaProductosExcesoStock"></ul>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Modal usuario -->
    <div th:replace="fragments/userModal :: userModal"></div>
    <div th:replace="fragments/jsComponents :: jsScripts"></div>

    <script th:inline="javascript">
        // ===================== AJAX y Chart.js =====================

       // Stock por Categoría
$.ajax({
    url: "/stockCategoria",
    type: "GET",
    success: function (data) {
        const labels = [];
        const stockValues = [];

        data.forEach(item => {
            labels.push(item.categoria); // nombre exacto desde Java
            stockValues.push(item.stock); // número exacto desde Java
        });

        // Total de productos y categorías
        $('#totalProductos').text(data.reduce((acc, cur) => acc + cur.stock, 0));
        $('#totalCategorias').text(data.length);

        // Crear gráfico
        const ctx = document.getElementById('graficoStockCategoria').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Stock total por categoría',
                    data: stockValues,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    },
    error: function (error) {
        console.error("Error al obtener el stock por categoría:", error);
    }
});


        // Movimientos por Tipo
        $.ajax({
            url: "/tipoMovimientos",
            type: "GET",
            success: function (data) {
                const labels = [];
                const stockValues = [];
                data.forEach(item => {
                    labels.push(item.TIPO_MOVIMIENTO);
                    stockValues.push(item.TOTAL_MOVIMIENTOS);
                });
                const ctx = document.getElementById('graficoTipoMovimientos').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Movimientos por tipo',
                            data: stockValues,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            },
            error: function (error) { console.error("Error al obtener movimientos por tipo:", error); }
        });

        // Productos con Stock Excesivo
        $.ajax({
            url: "/productos/excesoStock",
            type: "GET",
            success: function (data) {
                const listaAlertas = $('#listaProductosExcesoStock');
                listaAlertas.empty();
                data.forEach(item => {
                    listaAlertas.append(`<li><strong>${item.NOMBRE}</strong>: ${item.STOCK_ACTUAL} unidades</li>`);
                });
            },
            error: function (error) { console.error("Error al obtener productos con stock excesivo:", error); }
        });

        // Productos con Stock Bajo
        $.ajax({
            url: "/productos/stockBajo",
            type: "GET",
            success: function (data) {
                const labels = [];
                const stockMinValues = [];
                const stockActuValues = [];
                const listaAlertas = $('#listaProductosBajoStock');
                listaAlertas.empty();
                let contadorStockBajo = 0;

                data.forEach(item => {
                    labels.push(item.NOMBRE);
                    stockMinValues.push(item.STOCK_MINIMO);
                    stockActuValues.push(item.STOCK_ACTUAL);
                    if (item.STOCK_ACTUAL < item.STOCK_MINIMO) {
                        contadorStockBajo++;
                        listaAlertas.append(`<li><strong>${item.NOMBRE}</strong>: ${item.STOCK_ACTUAL} unidades (mínimo requerido: ${item.STOCK_MINIMO})</li>`);
                    }
                });

                $('#productosStockBajo').text(contadorStockBajo);

                const ctx = document.getElementById('graficoStockBajo').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Stock Mínimo', data: stockMinValues, backgroundColor: 'rgba(255, 99, 132, 0.5)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 1 },
                            { label: 'Stock Actual', data: stockActuValues, backgroundColor: 'rgba(54, 162, 235, 0.5)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }
                        ]
                    },
                    options: { indexAxis: 'y', responsive: true, scales: { x: { beginAtZero: true } }, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Productos con Stock por debajo del mínimo' } } }
                });
            },
            error: function (error) { console.error("Error al obtener productos con stock bajo:", error); }
        });

        // Productos Más Vendidos
        $.ajax({
            url: "/inventario/productosMasVendidos",
            type: "GET",
            success: function (data) {
                const labels = [];
                const stockValues = [];
                data.forEach(item => {
                    labels.push(item.NOMBRE);
                    stockValues.push(item.TOTAL_SALIDA);
                });
                $('#productosMasVendidos').text(data.length);

                const ctx = document.getElementById('graficoProductosMasVendidos').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{ label: 'Productos más vendidos', data: stockValues, backgroundColor: 'rgba(54, 162, 235, 0.5)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }]
                    },
                    options: { responsive: true, scales: { x: { beginAtZero: true } } }
                });
            },
            error: function (error) { console.error("Error al obtener productos más vendidos:", error); }
        });

    </script>
</body>

</html>
